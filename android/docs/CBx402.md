# Coinbase x402 Protocol - Repository Map

**Source:** `docs/Coinbasex402/`

This document provides a comprehensive map of the Coinbase x402 payment protocol repository for integration with Sol-AI-Bot's blockchain capabilities.

## Overview

**x402** is an open, internet-native payment protocol that enables seamless micropayments over HTTP and other transports. It leverages blockchain technology to provide:

- **1-line integration** for servers and clients
- **No fees** for resource servers or clients (gasless)
- **2-second settlement** with $0.001 minimum payments
- **Chain-agnostic** support (EVM, Solana, Sui)
- **Trust-minimizing** architecture

### Philosophy

x402 addresses fundamental flaws in internet payments:
- Credit cards have high friction, minimum payments, and percentage-based fees
- Traditional payment rails don't fit programmatic/AI agent use cases
- Aims to be amazing for both humans and AI agents

## Protocol Architecture

### Three Core Components

1. **Types**: Core data structures independent of transport and payment scheme
   - `PaymentRequirements`: Server's payment demands
   - `PaymentPayload`: Client's signed payment authorization
   - `SettlementResponse`: Blockchain transaction details

2. **Logic**: Payment formation/verification (scheme + network specific)
   - `exact`: Fixed amount transfers using EIP-3009
   - Future: `upto`, `deferred`, commerce schemes

3. **Representation**: Transport-specific encoding
   - HTTP headers (`X-PAYMENT`, `X-PAYMENT-RESPONSE`)
   - MCP (Model Context Protocol) messages
   - A2A (Agent-to-Agent) protocol

### Key Actors

- **Resource Server**: Service requiring payment for access
- **Client**: Application/agent requesting paid resources
- **Facilitator**: Third-party handling verification and blockchain settlement

## Repository Structure

```
Coinbasex402/
├── specs/                           # Protocol specifications
│   ├── x402-specification.md        # Core protocol spec
│   ├── transports/                  # Transport-specific specs
│   │   ├── http.md                  # HTTP transport (402 status code)
│   │   ├── mcp.md                   # Model Context Protocol
│   │   └── a2a.md                   # Agent-to-Agent protocol
│   └── schemes/                     # Payment scheme implementations
│       └── exact/                   # Exact payment scheme
│           ├── scheme_exact.md      # Scheme definition
│           ├── scheme_exact_evm.md  # EVM implementation (EIP-3009)
│           ├── scheme_exact_svm.md  # Solana implementation
│           └── scheme_exact_sui.md  # Sui implementation
│
├── typescript/                      # TypeScript implementation
│   └── packages/
│       ├── x402/                    # Core protocol library
│       │   ├── shared/              # Common types and utilities
│       │   ├── schemes/             # Payment scheme implementations
│       │   ├── client/              # Client-side payment logic
│       │   ├── verify/              # Payment verification
│       │   └── facilitator/         # Facilitator server logic
│       ├── x402-express/            # Express.js middleware
│       ├── x402-next/               # Next.js integration
│       ├── x402-hono/               # Hono framework support
│       ├── x402-axios/              # Axios client wrapper
│       ├── x402-fetch/              # Fetch API wrapper
│       └── coinbase-x402/           # Coinbase facilitator client
│
├── python/                          # Python implementation
│   └── x402/
│       └── src/x402/
│           ├── clients/             # HTTP client integrations
│           │   ├── httpx.py         # httpx client
│           │   ├── requests.py      # requests client
│           │   └── base.py          # Base client logic
│           ├── flask/               # Flask middleware
│           └── fastapi_tests/       # FastAPI middleware tests
│
├── go/                              # Go implementation
│   ├── pkg/
│   │   ├── types/                   # Type definitions
│   │   ├── coinbasefacilitator/     # Coinbase facilitator client
│   │   ├── facilitatorclient/       # Generic facilitator client
│   │   └── gin/                     # Gin framework middleware
│   └── examples/
│       └── server/                  # Example Go servers
│
├── java/                            # Java implementation
│   └── src/
│       ├── main/java/com/coinbase/x402/
│       │   ├── client/              # Client implementations
│       │   ├── crypto/              # Cryptographic operations
│       │   ├── model/               # Data models
│       │   ├── server/              # Server-side logic
│       │   └── util/                # Utilities
│       └── test/java/com/coinbase/x402/
│
├── examples/                        # Working examples
│   ├── typescript/                  # TS examples
│   │   └── fullstack/mainnet/       # Production-ready examples
│   └── python/                      # Python examples
│
├── e2e/                             # End-to-end tests
│
└── static/                          # Documentation assets
    └── x402-protocol-flow.png       # Protocol flow diagram
```

## Protocol Flow

1. **Client Request**: Client requests resource without payment
2. **402 Response**: Server returns `402 Payment Required` with `PaymentRequirements`
3. **Payment Authorization**: Client creates signed payment, sends with `X-PAYMENT` header
4. **Verification**: Server verifies payment (locally or via facilitator `/verify`)
5. **Settlement**: Server settles payment via blockchain (or facilitator `/settle`)
6. **Success Response**: Server returns resource + `X-PAYMENT-RESPONSE` with tx details

## Payment Schemes

### Exact Scheme (Current)

**Purpose**: Transfer specific amount (e.g., "$0.01 to read article")

**EVM Implementation** (scheme_exact_evm.md):
- Uses **EIP-3009** (Transfer with Authorization)
- Enables gasless transfers of ERC-20 tokens (USDC)
- Client signs `transferWithAuthorization` params with EIP-712
- Facilitator executes transaction on-chain

**Solana Implementation** (scheme_exact_svm.md):
- Token transfers with signed authorization
- Solana-native transaction construction
- Supported in core x402 TypeScript package

**Verification Steps**:
1. Signature validation (EIP-712 for EVM)
2. Balance verification
3. Amount validation
4. Time window check (validAfter/validBefore)
5. Parameter matching
6. Transaction simulation

### Future Schemes (Roadmap)

- **upto**: Usage-based payments (e.g., pay for LLM tokens generated)
- **deferred**: Pay after resource consumption
- **commerce**: Refunds and escrow flows

## Facilitator Interface

Facilitators provide HTTP REST APIs for blockchain operations:

### POST /verify
Verifies payment authorization without blockchain execution
- Input: `PaymentPayload` + `PaymentRequirements`
- Output: `{ isValid: boolean, invalidReason?: string, payer: string }`

### POST /settle
Executes verified payment on blockchain
- Input: Same as `/verify`
- Output: `{ success: boolean, transaction: string, network: string, payer: string }`

### GET /supported
Returns supported (scheme, network) pairs
- Output: `{ kinds: [{ x402Version, scheme, network }] }`

### Discovery API

**GET /discovery/resources**: List discoverable x402-enabled resources
- Enables "Bazaar" marketplace for AI agents and users
- Filter by type, paginate results
- Returns payment requirements for each resource

## Supported Networks & Tokens

### Networks
- **EVM**: base, base-sepolia, avalanche, avalanche-fuji, ethereum-mainnet, iotex
- **Solana**: mainnet-beta, devnet, testnet
- **Sui**: mainnet, testnet

### Tokens
- **USDC** (primary): EIP-3009 compliant on EVM chains
- **Future**: Arbitrary ERC-20 via Permit/Permit2 (Q2 2026 roadmap)

## Integration Patterns

### Server-Side (1 line of code)

**Express.js**:
```typescript
app.use(paymentMiddleware("0xYourAddress", { "/endpoint": "$0.01" }));
```

**Go (Gin)**:
```go
r.GET("/joke",
  x402gin.PaymentMiddleware(big.NewFloat(0.0001), "0xYourAddress"),
  handler
)
```

**Python (FastAPI)**:
```python
@app.get("/data")
@require_payment(amount=0.01, pay_to="0xYourAddress")
def get_data():
    return {"data": "..."}
```

### Client-Side

**Axios**:
```typescript
import { create402Axios } from 'x402-axios';
const client = create402Axios(wallet);
const response = await client.get('https://api.example.com/data');
```

**Python (httpx)**:
```python
from x402.clients.httpx import X402Client
client = X402Client(private_key)
response = client.get("https://api.example.com/data")
```

## Roadmap Highlights

### Now (Q4 2025)
- **Usage-based payment scheme** (`upto`)
- **MCP support** in x402 spec

### Next (Q4/Q1)
- Open-source CDP Go/TS facilitator
- Bazaar: External facilitator endpoint ingestion
- Payments MCP: Remote URL support
- Payments MCP: Solana support
- A2A support in Bazaar
- Identity solution guides

### Later (2026)
- ERC-8004 integration (Trustless Agents standard)
- Commerce scheme (refunds/escrow)
- Arbitrary token support (Permit/Permit2)
- XMTP support
- Facilitator router

## Project Ideas & Use Cases

### AI Agent Use Cases
- **Unstoppable Agent**: Provisions inference/tools via x402
- **Wealth Manager Bot**: Pays for market data, executes trades
- **Prediction Market Oracle**: Fetches consensus facts, pays per resolution
- **Bounty Hunter Agent**: Scans bounties, completes tasks autonomously

### Human Use Cases
- **Pay-per-use content**: Articles, videos, API calls
- **Session-based access**: Time-limited subscriptions
- **Rapid KYC/AML**: $0.25 per wallet screen
- **One-off services**: Code review, consultant booking

### Integration Examples
- Purchase-with-crypto shopper (Coinbase Commerce)
- Facebook Marketplace buyer agent
- Real-time fact checker for journalists
- Pay-as-you-learn tutor

## Security Considerations

1. **Replay Attack Prevention**:
   - EIP-3009 nonce (unique 32-byte random value)
   - Time constraints (validAfter/validBefore)
   - Blockchain-level nonce tracking

2. **Trust Minimization**:
   - Facilitators cannot move funds outside client authorization
   - Clients control payment timing and amount
   - Resource servers verify before service

3. **Authentication Integration**:
   - SIWE (Sign-In with Ethereum) support
   - Authenticated users get discounted rates

## Error Codes

- `insufficient_funds`: Client lacks tokens
- `invalid_exact_evm_payload_signature`: Invalid signature
- `invalid_exact_evm_payload_authorization_value`: Insufficient payment
- `invalid_exact_evm_payload_authorization_valid_after`: Not yet valid
- `invalid_exact_evm_payload_authorization_valid_before`: Expired
- `invalid_network`: Unsupported blockchain
- `unsupported_scheme`: Unsupported payment scheme

## Key Files for Sol-AI-Bot Integration

### Understanding the Protocol
1. `specs/x402-specification.md` - Core protocol definition
2. `specs/transports/http.md` - HTTP-specific implementation
3. `specs/schemes/exact/scheme_exact_svm.md` - **Solana implementation**

### Implementation References
1. `typescript/packages/x402/` - Core library with Solana support
2. `examples/typescript/` - Working examples
3. `java/src/main/java/com/coinbase/x402/` - Java implementation (for Android)

### Solana-Specific
- TypeScript package includes Solana dependencies:
  - `@solana/kit`
  - `@solana-program/token`
  - `@solana-program/compute-budget`
- Transaction confirmation with `@solana/transaction-confirmation`

## Integration Strategy for Sol-AI-Bot

### Phase 1: Client Integration
1. Study `specs/schemes/exact/scheme_exact_svm.md` for Solana payment flow
2. Review TypeScript client implementation in `typescript/packages/x402/client/`
3. Port client logic to Kotlin using existing Solana Mobile SDK

### Phase 2: Resource Server (Optional)
1. Create Kotlin middleware for x402 payment acceptance
2. Use existing Mobile Wallet Adapter for transaction signing
3. Integrate with Coinbase facilitator or run own

### Phase 3: AI Agent Integration
1. Enable LLM function calling to pay for external APIs
2. Budget management and spending controls
3. Discover resources via Bazaar API
4. Correlation tracking for multi-step operations

## Community & Contribution

- **License**: Apache 2.0
- **Repository**: https://github.com/coinbase/x402
- **Micro-grants**: Up to $3k for mainnet projects
- **Contact**: @murrlincoln on X/GitHub, @coinbaseDev on X

### Community-Friendly Roadmap Items
- Arbitrary token support (Permit/Permit2 for EVM)
- XMTP support in x402
- Identity solution proposals
- MCP support co-authoring
- Solution guides & demos

## Technical Notes

### Transport Agnostic Design
- Core types are transport-independent
- Schemes define payment logic independent of transport
- Transport specs (HTTP, MCP, A2A) handle representation

### Multi-Chain Support
- EVM chains via viem library
- Solana via @solana/kit
- Sui support in development

### Framework Support
- **TypeScript**: Express, Next.js, Hono
- **Python**: FastAPI, Flask
- **Go**: Gin
- **Java**: Spring Boot compatible

## Version History

- **v0.6.6** (Current): Stable HTTP + exact scheme, Solana support in TS
- **v0.2** (2025-10-3): Transport-agnostic redesign
- **v0.1** (2025-08-29): Initial HTTP-only draft

---

## Quick Reference: Key Concepts

| Concept | Description |
|---------|-------------|
| **x402 Protocol** | Open standard for internet-native payments over HTTP |
| **402 Status Code** | HTTP status indicating "Payment Required" |
| **EIP-3009** | Transfer with Authorization (gasless ERC-20 transfers) |
| **Facilitator** | Third-party service handling blockchain operations |
| **Exact Scheme** | Fixed-amount payment scheme (current implementation) |
| **PaymentRequirements** | Server's specification of accepted payment methods |
| **PaymentPayload** | Client's signed authorization for payment |
| **Bazaar** | Marketplace/discovery service for x402 resources |
| **MCP** | Model Context Protocol (AI agent tool integration) |
| **A2A** | Agent-to-Agent protocol for direct agent payments |

---

**Last Updated**: 2025-10-07
**Sol-AI-Bot Version**: 1.0.7
**For integration questions**: Reference this document + original specs in `/proj/docs/Coinbasex402/specs/`
